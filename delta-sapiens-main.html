<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>

let serverURL = 'https://delta-sapiens-backend-kgadbyj3ca-uc.a.run.app/';
let threadId = '';
let isUserScrolling = false;
let isTyping = false;
var numOfMessages = 0;
var lastMessage = "";
var suggestionButtons;
var chatInput = $("#chatInput");
var submitButton = $("#submitButton");
var chatOutput = $("#chatOutput");
var newChatBtn = $("#newChatBtn");
var newChatBtn_M = $("#newChatBtn_M");
var submitBtn_grayBck = 'https://uploads-ssl.webflow.com/65ad1866ca4e4a4ade2f9348/65ca0e43d1ee28d616bcbe6b_grayButton.png'
var submitBtn_orangeBck = 'https://uploads-ssl.webflow.com/65ad1866ca4e4a4ade2f9348/65ca0e4308c7b617525527dd_orangeButton.png'
chatInput.disabled = true;
var defaultInputHeight;
var isMobile;
var isNewChatDisabled;


document.addEventListener('DOMContentLoaded', function() {
    isMobile = window.innerWidth <= 768;
    chatInput.rows = 1;
    chatInput.style.height = chatInput.scrollHeight + 'px';
    defaultInputHeight = chatInput.style.height;
    chatInput.style.maxHeight = (chatInput.scrollHeight + chatInput.scrollHeight / 2) + 'px';

    fetch(`${serverURL}start`)
        .then(response => response.json())
        .then(data => {
            threadId = data.thread_id; 
            chatInput.disabled = false;
        })
        .catch(error => console.error('Error starting conversation:', error));

    const chatOutputDiv = chatOutput;
    chatOutputDiv.addEventListener('scroll', function() {
        if (chatOutputDiv.scrollTop + chatOutputDiv.clientHeight < chatOutputDiv.scrollHeight) {
            isUserScrolling = true;
        } else {
            isUserScrolling = false;
        }
    });

    window.addEventListener('keydown', function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            ChatOps();
        }
    });


    chatInput.addEventListener('input', function() {
        if (chatInput.value.trim() !== '') {
            submitButton.children[0].src = submitBtn_orangeBck;
        } else {
            submitButton.children[0].src = submitBtn_grayBck;
        }
    });

});


newChatBtn.addEventListener('click', function(event) {
    NewChat(this);
});

newChatBtn_M.addEventListener('click', function(event) {
    NewChat(this);
});

function NewChat(button){

    if(isNewChatDisabled)
    return;
        
    button.classList.add('pop-effect');
    setTimeout(() => {
        button.classList.remove('pop-effect');
    }, 125);


    resetInputHeight();
    //RESET CHAT

    isTyping = false;
    chatInput.value = null;
    chatOutput.innerHTML = null;
    chatOutput.style.display = 'none'
    $('#logo-section').css('display', 'flex');



    if (isMobile) {
    // Mobile
    $('#suggestionSection2').css('display', 'flex');
    } else {
        $('#suggestionSection').css('display', 'flex');
        $('#deltaText').css('display', 'block');
    }


    ClearSuggestions();

}


function ClearSuggestions(){
    suggestionButtons = document.querySelectorAll('.suggestionbutton');
    suggestionButtons.forEach(function(button) {
        button.classList.remove('active');
        chatInput.value = null;
        submitButton.children[0].src = submitBtn_grayBck;
    });
}

chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});

function resetInputHeight(){
    chatInput.style.height = 'auto';
    chatInput.style.height = defaultInputHeight;
}


submitButton.addEventListener('click', function(event) {
    this.classList.add('pop-effect');
    setTimeout(() => {
        this.classList.remove('pop-effect');
    }, 125);

    if(chatInput.value.length != 0 && chatInput.value != " ")
        ChatOps();
    else return

});

function ChatOps(){
    if (isTyping) {
        return; 
    }

    resetInputHeight();
    const message = chatInput.value; // Get the input value
    isUserScrolling = false;


const requestData = {
    thread_id: threadId,
    message: message
};

chatInput.value = '';

const newUserBubble = `
            <div class="chatboubble">
                <div class="profileimg">
                    <img src="https://uploads-ssl.webflow.com/65ad1866ca4e4a4ade2f9348/65b5454521078c5d2745c167_219988.png" loading="lazy" alt="" class="profimg">
                </div>
                <div class="textzone">
                    <h1 class="botname">You</h1>
                    <p class="responsecontent">${message}</p> <!-- Insert the response message here -->
                </div>
            </div>`;

chatOutput.style.display = 'flex'
chatOutput.innerHTML += newUserBubble

$('#logo-section').css('display', 'none');
$('#deltaText').css('display', 'none');
$('#suggestionSection').css('display', 'none');
$('#suggestionSection2').css('display', 'none');

const AIoutputpreview = `
            <div class="chatboubble grayOutput">
                <div class="profileimg">
                    <img src="https://assets-global.website-files.com/65ad1866ca4e4a4ade2f9348/65ad1a2f470ea4639ecfac20_orange_circle.svg" loading="lazy" alt="" class="profimg rotating">
                </div>
                <div class="textzone">
                    <h1 class="botname">Delta Sapiens</h1>
                    <p class="responsecontent">Delta Sapiens razmislja...</p> <!-- Insert the response message here -->
                </div>
            </div>`;

chatOutput.innerHTML += AIoutputpreview
isTyping = true;
chatOutput.scrollTop = chatOutput.scrollHeight
submitButton.children[0].src = submitBtn_grayBck;

isNewChatDisabled = true;
newChatBtn.style.opacity = 0.5;
newChatBtn_M.style.opacity = 0.5;


fetch(`${serverURL}chat`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestData)
})
.then(response => {
    const reader = response.body.getReader();
    let charsReceived = 0;
    var fullText = '';

    var lastMessageElem = chatOutput.lastElementChild;

    lastMessageElem.getElementsByClassName("responsecontent")[0].innerText = "";
    lastMessageElem.getElementsByClassName("profimg")[0].classList.remove("rotating");

    const processNextChunk = () => {
        reader.read().then(({done, value}) => {
            if (done) {
                console.log("Stream complete");
                isTyping = false;
                chatInput.disabled = false;
                submitButton.disabled = false;
                
                isNewChatDisabled = false;
                newChatBtn.style.opacity = 1;
                newChatBtn_M.style.opacity = 1;

                fullText = fullText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                const responseContent = lastMessageElem.getElementsByClassName("responsecontent")[0];
                responseContent.innerText = null
                responseContent.innerHTML += fullText;


                var assistent_response = "";
                assistent_response = fullText;

                if(numOfMessages == 0){
                    assistent_response = "";
                    numOfMessages++;
                }
        
                const requestData_addR = {
                    thread_id: threadId,
                    message: message,
                    assistent_response: assistent_response
                    };


                    fetch(`${serverURL}add-response`, {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData_addR)
                    })
                    .then(response => response.json())
                    .then(data => {
                    console.log('Response from server:', data); 
                    }).catch(error => console.error('Error sending message:', error));


                return;
            }


            const chunkText = new TextDecoder().decode(value);
            charsReceived += chunkText.length;
            fullText += chunkText;


            const responseContent = lastMessageElem.getElementsByClassName("responsecontent")[0];
            responseContent.innerHTML += chunkText;


            if (!isUserScrolling) {
                chatOutput.scrollTop = chatOutput.scrollHeight;
            }


            processNextChunk();
        });
    };


    processNextChunk();
})
.catch(error => console.error('Error while fetching the chat stream:', error));



}

</script>
<script src="https://unpkg.com/popper.js@1"></script>
<script src="https://unpkg.com/tippy.js@4"></script>
<script>
tippy('.tooltip', {        
 animation: 'fade',    
 duration: 200,      
 arrow: true,          
 delay: [0, 50],      
 arrowType: 'sharp',  
 theme: 'material',        
 maxWidth: 220,    
 interactive: true,
})
</script>